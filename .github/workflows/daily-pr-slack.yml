name: Daily PRs to Slack (ready for review)

on:
  schedule:
    # Weekdays at 07:00 UTC ≈ 09:00 Europe/Prague
    - cron: '0 7 * * 1-5'
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: read
  checks: read
  statuses: read

concurrency:
  group: prs-to-slack
  cancel-in-progress: true

jobs:
  post-ready-prs:
    runs-on: ubuntu-latest
    env:
      SLACK_WORKFLOW_WEBHOOK_URL: ${{ secrets.SLACK_WORKFLOW_WEBHOOK_URL }} # <-- ulož sem tvoji URL
      GH_TOKEN: ${{ github.token }}
    steps:
      - name: Guard – missing webhook
        if: env.SLACK_WORKFLOW_WEBHOOK_URL == ''
        run: |
          echo "Secret SLACK_WORKFLOW_WEBHOOK_URL is not set. Skipping."
          exit 0

      - name: Install jq & gh
        run: |
          sudo apt-get update -y
          sudo apt-get install -y jq gh

      - name: Collect PRs (open & not draft) + checks summary
        id: collect
        shell: bash
        run: |
          set -euo pipefail
          REPO="${{ github.repository }}"

          # Pull all open, non-draft PRs (paginate)
          mapfile -t PRS < <(gh api "/repos/${REPO}/pulls?state=open&per_page=100" --paginate \
            | jq -r '.[] | select(.draft==false) | @base64')

          if [ ${#PRS[@]} -eq 0 ]; then
            MSG="*Good morning!* No open PRs ready for review today."
            printf '%s' "$MSG" | jq -Rs --arg k "text" '{($k): .}' \
              | sed 's/"text"/"pr-review"/' > /tmp/payload.json
            echo "payload=$(cat /tmp/payload.json | base64 -w0)" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          MSG="*Good morning!* PRs ready for review in <${{ github.server_url }}/${REPO}|${REPO}>:\n"
            row="$(echo "$b64" | base64 -d)"
            number="$(echo "$row" | jq -r '.number')"
            title="$(echo "$row" | jq -r '.title')"
            url="$(echo "$row" | jq -r '.html_url')"
            author="$(echo "$row" | jq -r '.user.login')"
            reviewers="$(echo "$row" | jq -r '[.requested_reviewers[].login] | join(", ")')"
            [ -z "$reviewers" ] && reviewers="(no reviewers requested)"
            sha="$(echo "$row" | jq -r '.head.sha')"

            # Prefer GitHub Checks API; fallback to combined Status API if no check-runs
            chk_json="$(gh api -H 'Accept: application/vnd.github+json' "/repos/${REPO}/commits/${sha}/check-runs?per_page=100")"
            total_chk="$(jq -r '.check_runs | length' <<<"$chk_json")"

            if [ "$total_chk" -gt 0 ]; then
              success="$(jq -r '[.check_runs[] | select(.status=="completed" and .conclusion=="success")] | length' <<<"$chk_json")"
              failed="$(jq -r '[.check_runs[] | select(.status=="completed" and (.conclusion=="failure" or .conclusion=="timed_out" or .conclusion=="cancelled" or .conclusion=="action_required"))] | length' <<<"$chk_json")"
              pending="$(jq -r '[.check_runs[] | select(.status!="completed")] | length' <<<"$chk_json")"
              checks="checks: ${success}✓ / ${failed}✖ / ${pending}⏳"
            else
              # Combined status contexts (success/failure/pending)
              stat_json="$(gh api "/repos/${REPO}/commits/${sha}/status")"
              state="$(jq -r '.state' <<<"$stat_json")"  # success | failure | pending | error
              ctxs="$(jq -r '.statuses' <<<"$stat_json")"
              ok="$(jq -r '[.[] | select(.state=="success")] | length' <<<"$ctxs")"
              ko="$(jq -r '[.[] | select(.state=="failure" or .state=="error")] | length' <<<"$ctxs")"
              pd="$(jq -r '[.[] | select(.state=="pending")] | length' <<<"$ctxs")"
              checks="status: *${state}* (${ok}✓ / ${ko}✖ / ${pd}⏳)"
            fi

            MSG+="- <${url}|#${number}> ${title} — by *${author}* — reviewers: ${reviewers} — ${checks}\n"
          done

          # Build Slack Workflow payload with your input field "pr-review"
          printf '%s' "$MSG" | jq -Rs '{("pr-review"): .}' > /tmp/payload.json
          echo "payload=$(cat /tmp/payload.json | base64 -w0)" >> "$GITHUB_OUTPUT"

      - name: Post to Slack (Workflow Webhook)
        env:
          SLACK_WORKFLOW_WEBHOOK_URL: ${{ secrets.SLACK_WORKFLOW_WEBHOOK_URL }}
        run: |
          echo "${{ steps.collect.outputs.payload }}" | base64 -d \
            | curl -sS -X POST -H 'Content-Type: application/json' \
              --data @- "$SLACK_WORKFLOW_WEBHOOK_URL"
